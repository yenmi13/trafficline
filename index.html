<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>道路標線施工統計工具</title>
    <!-- 引入 Tailwind CSS 用於快速樣式 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* 禁止選取文字，避免按鈕操作時誤選 */
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* 隱藏數字輸入框的箭頭 */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* 點擊效果 */
        .btn-active:active {
            transform: scale(0.95);
        }

        /* 自定義捲軸樣式 */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
    </style>
</head>

<body class="bg-slate-100 text-slate-800 font-sans h-screen flex flex-col overflow-hidden">

    <!-- 頂部標題與總計 (極度壓縮版) -->
    <header
        class="bg-white p-2 shadow-sm border-b border-slate-200 z-20 flex justify-between items-center shrink-0 h-12">
        <div class="flex items-center gap-1.5">
            <i data-lucide="calculator" class="text-blue-600 w-5 h-5"></i>
            <h1 class="font-bold text-sm leading-tight">標線統計</h1>
        </div>
        <div class="text-right flex items-baseline gap-1">
            <div class="text-[10px] text-slate-400 uppercase">總計</div>
            <div class="text-lg font-bold text-blue-600 font-mono leading-none">
                <span id="display-total-area">0.00</span> <span class="text-xs text-slate-500">m²</span>
            </div>
        </div>
    </header>

    <!-- 主內容區 -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden relative">

        <!-- 左側：操作面板 (類型選擇 + 鍵盤) -->
        <div class="flex-1 flex flex-col md:w-3/5 h-full overflow-hidden">

            <!-- 1. 類型選擇區 (支援分類顯示) - 最大化空間 -->
            <div class="flex-1 p-2 overflow-y-auto bg-slate-50 relative" id="type-scroll-container">
                <div class="flex justify-between items-center sticky top-0 bg-slate-50 py-1 z-20 mb-2 shadow-sm">
                    <h2 class="text-xs font-bold text-slate-500 flex items-center gap-1">
                        <i data-lucide="grid" class="w-3 h-3"></i> 1. 選擇類型
                    </h2>
                    <button onclick="resetTypes()" class="text-[10px] text-blue-500 underline px-2">恢復預設</button>
                </div>

                <!-- 這裡不再是單一 Grid，而是由 JS 動態生成的分類區塊 -->
                <div id="type-list-container" class="pb-10 space-y-3">
                    <!-- JS 將在此渲染分類與按鈕 -->
                </div>
            </div>

            <!-- 2. 輸入與鍵盤區 (高度壓縮) -->
            <div class="bg-white p-2 border-t border-slate-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20 shrink-0">

                <!-- 顯示螢幕 (高度縮小) -->
                <div
                    class="bg-slate-100 rounded-lg p-1.5 mb-1.5 text-right border border-slate-200 flex flex-col justify-center h-14 relative group">
                    <!-- 類型名稱與修改按鈕 -->
                    <div class="absolute top-1 left-2 flex items-center gap-2">
                        <div id="screen-type-name" class="text-[10px] text-slate-500 font-bold truncate max-w-[120px]">
                            請選擇</div>
                        <!-- 修改係數按鈕 -->
                        <button onclick="editCurrentFactors()"
                            class="bg-slate-200 hover:bg-slate-300 text-slate-600 rounded px-1 py-0.5 text-[9px] flex items-center gap-0.5 transition-colors"
                            title="修改規格">
                            <i data-lucide="settings-2" class="w-3 h-3"></i>
                            修改
                        </button>
                    </div>

                    <div class="flex items-baseline justify-end gap-1 px-1">
                        <span id="screen-value"
                            class="text-2xl font-mono font-bold text-slate-800 leading-none">0</span>
                        <span id="screen-unit" class="text-xs text-slate-400">m</span>
                    </div>
                    <!-- 預覽縮小 -->
                    <div id="screen-calc-preview" class="text-[9px] text-blue-500 h-3 truncate px-1"></div>
                </div>

                <!-- 數字鍵盤 (按鈕高度縮小) -->
                <div class="grid grid-cols-4 gap-1.5 select-none pb-1">
                    <button class="key-btn bg-white border-b-2 border-slate-200" onclick="inputKey('7')">7</button>
                    <button class="key-btn bg-white border-b-2 border-slate-200" onclick="inputKey('8')">8</button>
                    <button class="key-btn bg-white border-b-2 border-slate-200" onclick="inputKey('9')">9</button>
                    <button class="key-btn bg-red-50 text-red-500 border border-red-100" onclick="inputKey('DEL')"><i
                            data-lucide="delete" class="w-4 h-4 mx-auto"></i></button>

                    <button class="key-btn bg-white border-b-2 border-slate-200" onclick="inputKey('4')">4</button>
                    <button class="key-btn bg-white border-b-2 border-slate-200" onclick="inputKey('5')">5</button>
                    <button class="key-btn bg-white border-b-2 border-slate-200" onclick="inputKey('6')">6</button>
                    <button class="key-btn bg-red-50 text-red-500 border border-red-100"
                        onclick="inputKey('AC')">AC</button>

                    <button class="key-btn bg-white border-b-2 border-slate-200" onclick="inputKey('1')">1</button>
                    <button class="key-btn bg-white border-b-2 border-slate-200" onclick="inputKey('2')">2</button>
                    <button class="key-btn bg-white border-b-2 border-slate-200" onclick="inputKey('3')">3</button>
                    <button
                        class="key-btn row-span-2 bg-blue-600 text-white rounded-lg shadow-md active:bg-blue-700 flex flex-col items-center justify-center gap-0.5"
                        onclick="submitInput()">
                        <span class="text-base font-bold">確認</span>
                        <i data-lucide="corner-down-left" class="w-3 h-3"></i>
                    </button>

                    <button class="key-btn col-span-2 bg-white border-b-2 border-slate-200"
                        onclick="inputKey('0')">0</button>
                    <button class="key-btn bg-white border-b-2 border-slate-200" onclick="inputKey('.')">.</button>
                </div>
            </div>
        </div>

        <!-- 右側：列表區 (手機版預設隱藏或作為底部抽屜，這裡維持桌面版邏輯，手機版需手動滑動或切換) -->
        <!-- 為了手機體驗，建議將列表區在手機上設為較矮的高度，或者依賴「總計」來確認 -->
        <div
            class="flex flex-col md:w-80 lg:w-96 bg-slate-50 border-t md:border-t-0 md:border-l border-slate-200 h-[30vh] md:h-full shrink-0">
            <div class="p-2 border-b border-slate-200 bg-white flex justify-between items-center shadow-sm h-10">
                <h3 class="font-bold text-slate-700 text-xs flex items-center gap-2">
                    <i data-lucide="history" class="w-3 h-3"></i> 統計列表
                </h3>
                <button onclick="clearAll()"
                    class="text-[10px] text-red-500 border border-red-200 px-2 py-0.5 rounded hover:bg-red-50">清空</button>
            </div>

            <div id="history-list" class="flex-1 overflow-y-auto p-2 space-y-2 text-sm">
                <!-- JS 渲染列表 -->
                <div class="text-center text-slate-400 mt-4 text-xs">暫無資料</div>
            </div>

            <div class="p-2 bg-white border-t border-slate-200">
                <button onclick="copyReport()"
                    class="w-full py-2 bg-slate-800 text-white rounded-lg font-bold shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 text-sm">
                    <i data-lucide="clipboard-copy" class="w-4 h-4"></i>
                    複製報表
                </button>
            </div>
        </div>

    </main>

    <!-- 自訂項目 Modal -->
    <div id="modal-custom" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-5 shadow-2xl transform transition-all scale-100">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                <i data-lucide="plus-circle" class="text-blue-600"></i> 新增自訂項目
            </h3>

            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">項目名稱</label>
                    <input type="text" id="custom-name" placeholder="例如：6m行穿線"
                        class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500">
                    <div class="text-[10px] text-slate-400 mt-1">若名稱包含「行穿線」，將自動套用專屬格式 (長x寬)</div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">計算方式</label>
                        <select id="custom-type" class="w-full p-2 border border-slate-300 rounded-lg bg-white"
                            onchange="updateCustomLabels()">
                            <option value="linear">長度 (m)</option>
                            <option value="count">數量 (個/點/條)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1" id="custom-value-label">係數
                            (可輸入算式)</label>
                        <input type="text" id="custom-factors" placeholder="例如: 6*0.4"
                            class="w-full p-2 border border-slate-300 rounded-lg">
                        <div class="text-[10px] text-slate-400 mt-1">
                            支援多階：例如 "6*0.4" 代表 長6m×寬0.4m
                        </div>
                    </div>
                </div>

                <div class="text-xs text-slate-400 bg-slate-100 p-2 rounded">
                    預覽公式：<span id="custom-preview" class="font-mono">1m * ? = ?m²</span>
                </div>
            </div>

            <div class="flex gap-2 mt-6">
                <button onclick="closeModal()"
                    class="flex-1 py-2 text-slate-500 font-bold bg-slate-100 rounded-lg hover:bg-slate-200">取消</button>
                <button onclick="saveCustomType()"
                    class="flex-1 py-2 text-white font-bold bg-blue-600 rounded-lg hover:bg-blue-700 shadow-md">新增</button>
            </div>
        </div>
    </div>

    <!-- 複製成功提示 -->
    <div id="toast"
        class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/80 text-white px-6 py-4 rounded-xl shadow-2xl z-50 hidden flex-col items-center">
        <i data-lucide="check-circle" class="w-8 h-8 text-green-400 mb-2"></i>
        <div class="font-bold text-lg">複製成功！</div>
        <div class="text-sm text-gray-300 mt-1">您可以直接貼上至 Line 或 Excel</div>
    </div>

    <script>
        // ----------------------
        // 1. 初始化資料與狀態
        // ----------------------

        // 定義分類順序與名稱
        const CATEGORIES = {
            'A': 'A. 10cm道路標線',
            'B': 'B. 15cm道路標線',
            'C': 'C. 40cm道路標線',
            'D': 'D. 停等區與車格類標線',
            'E': 'E. 字模標線',
            'F': 'F. 內外型標線',
            'G': 'G. 其他與未分類、自訂義'
        };

        const INITIAL_TYPES = [
            // --- A. 10cm道路標線 ---
            { id: 'white_line', name: '白線', category: 'A', type: 'linear', factors: [0.1], color: 'bg-blue-50 border-blue-200 text-blue-800' },
            { id: 'yellow_line', name: '黃線', category: 'A', type: 'linear', factors: [0.1], color: 'bg-yellow-50 border-yellow-200 text-yellow-800' },
            { id: 'red_line', name: '紅線', category: 'A', type: 'linear', factors: [0.1], color: 'bg-red-50 border-red-200 text-red-800' },
            { id: 'blue_line', name: '藍線', category: 'A', type: 'linear', factors: [0.1], color: 'bg-blue-50 border-blue-200 text-blue-800' },
            { id: 'double_yellow', name: '雙黃線', category: 'A', type: 'linear', factors: [0.1, 2.0], color: 'bg-yellow-50 border-yellow-200 text-yellow-800' },
            { id: 'double_white', name: '雙白線', category: 'A', type: 'linear', factors: [0.1, 2.0], color: 'bg-gray-50 border-gray-200 text-gray-800' },
            { id: 'diag_ped', name: '對角線行人穿越線', category: 'A', type: 'linear', factors: [0.1], color: 'bg-gray-50 border-gray-200 text-gray-800' },
            { id: 'bike_line', name: '自行車道線', category: 'A', type: 'linear', factors: [0.1], color: 'bg-blue-50 border-blue-200 text-blue-800' },
            { id: 'cross_road', name: '岔路線', category: 'A', type: 'linear', factors: [0.1], color: 'bg-gray-50 border-gray-200 text-gray-800' },
            { id: 'white_dot', name: '白點線', category: 'A', type: 'count', factors: [4.0, 0.1], color: 'bg-teal-50 border-teal-200 text-teal-800' }, // Moved from G
            { id: 'yellow_dot', name: '黃點線', category: 'A', type: 'count', factors: [4.0, 0.1], color: 'bg-yellow-50 border-yellow-200 text-yellow-800' }, // Moved from G

            // --- B. 15cm道路標線 ---
            { id: 'white_edge', name: '白邊線', category: 'B', type: 'linear', factors: [0.15], color: 'bg-blue-50 border-blue-200 text-blue-800' },
            { id: 'wait_zone_border', name: '待轉區框', category: 'B', type: 'linear', factors: [0.15], color: 'bg-purple-50 border-purple-200 text-purple-800' },
            { id: 'guide_point', name: '引導線', category: 'B', type: 'count', factors: [0.1, 0.5], color: 'bg-teal-50 border-teal-200 text-teal-800' }, // Moved from G & Renamed
            { id: 'bus_box_15', name: '公車框', category: 'B', type: 'linear', factors: [0.15], color: 'bg-purple-50 border-purple-200 text-purple-800' }, // New Item

            // --- C. 40cm道路標線 ---
            { id: 'stop_line', name: '停止線', category: 'C', type: 'linear', factors: [0.4], color: 'bg-red-50 border-red-200 text-red-800' },
            { id: 'zebra_1m', name: '1m行穿線', category: 'C', type: 'count', factors: [1.0, 0.4], color: 'bg-gray-50 border-gray-200 text-gray-800' },
            { id: 'zebra_2m', name: '2m行穿線', category: 'C', type: 'count', factors: [2.0, 0.4], color: 'bg-gray-50 border-gray-200 text-gray-800' },
            { id: 'zebra_3m', name: '3m行穿線', category: 'C', type: 'count', factors: [3.0, 0.4], color: 'bg-gray-50 border-gray-200 text-gray-800' },
            { id: 'zebra_4m', name: '4m行穿線', category: 'C', type: 'count', factors: [4.0, 0.4], color: 'bg-gray-50 border-gray-200 text-gray-800' },
            { id: 'zebra_5m', name: '5m行穿線', category: 'C', type: 'count', factors: [5.0, 0.4], color: 'bg-gray-50 border-gray-200 text-gray-800' },
            { id: 'checker_board', name: '黃棋盤標線', category: 'C', type: 'linear', factors: [0.4], color: 'bg-yellow-100 border-yellow-300 text-yellow-900' },

            // --- D. 停等區與車格類標線 ---
            { id: 'wait_zone_v', name: '停等區直', category: 'D', type: 'linear', factors: [0.1, 2.0], color: 'bg-purple-50 border-purple-200 text-purple-800' },
            { id: 'wait_zone_h', name: '停等區橫', category: 'D', type: 'linear', factors: [0.2, 2.0], color: 'bg-purple-50 border-purple-200 text-purple-800' },
            { id: 'scooter_box', name: '機車格線', category: 'D', type: 'linear', factors: [0.1], color: 'bg-indigo-50 border-indigo-200 text-indigo-800' },
            { id: 'car_box', name: '汽車格線', category: 'D', type: 'linear', factors: [0.1], color: 'bg-indigo-50 border-indigo-200 text-indigo-800' },
            { id: 'truck_box', name: '貨車格線', category: 'D', type: 'linear', factors: [0.1], color: 'bg-indigo-50 border-indigo-200 text-indigo-800' },
            { id: 'taxi_box', name: '計程車格線', category: 'D', type: 'linear', factors: [0.1], color: 'bg-indigo-50 border-indigo-200 text-indigo-800' },
            { id: 'dis_scooter_box', name: '殘障機車格線', category: 'D', type: 'linear', factors: [0.1], color: 'bg-indigo-50 border-indigo-200 text-indigo-800' },
            { id: 'dis_car_box', name: '殘障汽車格線', category: 'D', type: 'linear', factors: [0.1], color: 'bg-indigo-50 border-indigo-200 text-indigo-800' },
            { id: 'bus_box', name: '公車框線', category: 'D', type: 'linear', factors: [0.1], color: 'bg-indigo-50 border-indigo-200 text-indigo-800' },
            { id: 'fire_box', name: '消防空間引框', category: 'D', type: 'linear', factors: [0.1], color: 'bg-red-50 border-red-200 text-red-800' },

            // --- E. 字模標線 ---
            { id: 'arrow_idx', name: '指標箭頭', category: 'E', type: 'count', factors: [1.0], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'arrow_point', name: '指向箭', category: 'E', type: 'count', factors: [3.0], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'bike_sym', name: '自行車符號', category: 'E', type: 'count', factors: [3.0], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'scooter_sym', name: '機車符號', category: 'E', type: 'count', factors: [6.0], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'dis_scooter_sym', name: '殘障機車符號', category: 'E', type: 'count', factors: [2.0], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'dis_car_sym', name: '殘障汽車符號', category: 'E', type: 'count', factors: [3.0], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'spec_lane_sym', name: '專用道符號', category: 'E', type: 'count', factors: [2.5], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'ped_sym', name: '行人符號', category: 'E', type: 'count', factors: [3.0], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'yield_sym', name: '讓路符號', category: 'E', type: 'count', factors: [3.0], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'zig_zag', name: '鋸齒型標線', category: 'E', type: 'count', factors: [2.0], color: 'bg-green-50 border-green-200 text-green-800' },
            { id: 'speed_30', name: '限速30', category: 'E', type: 'count', factors: [2.5], color: 'bg-red-50 border-red-200 text-red-800' },
            { id: 'speed_40', name: '限速40', category: 'E', type: 'count', factors: [2.5], color: 'bg-red-50 border-red-200 text-red-800' },
            { id: 'speed_50', name: '限速50', category: 'E', type: 'count', factors: [2.5], color: 'bg-red-50 border-red-200 text-red-800' },
            { id: 'time_num', name: '時間號碼', category: 'E', type: 'count', factors: [12.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'box_num_hot', name: '車格號碼熱拌', category: 'E', type: 'count', factors: [1.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'box_num_paint', name: '油漆車格號碼', category: 'E', type: 'count', factors: [0.5], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_class', name: '上課時間字', category: 'E', type: 'count', factors: [1.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_no_park_time', name: '時段性禁停字', category: 'E', type: 'count', factors: [1.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_wait_scooter', name: '機慢車待轉區字', category: 'E', type: 'count', factors: [1.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_wait', name: '待轉區字', category: 'E', type: 'count', factors: [2.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_slow', name: '慢', category: 'E', type: 'count', factors: [2.5], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_stop', name: '停', category: 'E', type: 'count', factors: [2.5], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_no_scooter', name: '禁行機車', category: 'E', type: 'count', factors: [2.5], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_general_road', name: '一般道路', category: 'E', type: 'count', factors: [2.5], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_cross_fine', name: '越線受罰', category: 'E', type: 'count', factors: [2.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_bus_only', name: '公車專用', category: 'E', type: 'count', factors: [2.5], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_bus_stop', name: '公車停靠區', category: 'E', type: 'count', factors: [2.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_sidewalk', name: '人行道', category: 'E', type: 'count', factors: [2.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_taxi_only', name: '計程車專用', category: 'E', type: 'count', factors: [2.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_truck_zone', name: '貨車裝卸專用區字', category: 'E', type: 'count', factors: [1.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'text_taxi_stand', name: '計程車招呼站字', category: 'E', type: 'count', factors: [1.0], color: 'bg-gray-100 border-gray-300 text-gray-700' },

            // --- F. 內外型標線 ---
            { id: 'yellow_grid_in', name: '黃網線內', category: 'F', type: 'linear', factors: [0.1], color: 'bg-yellow-100 border-yellow-300 text-yellow-900' },
            { id: 'yellow_grid_out', name: '黃網線外', category: 'F', type: 'linear', factors: [0.2], color: 'bg-yellow-100 border-yellow-300 text-yellow-900' },
            { id: 'white_chev_out', name: '白槽化線外', category: 'F', type: 'linear', factors: [0.1], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'white_chev_in', name: '白槽化線內', category: 'F', type: 'linear', factors: [0.2], color: 'bg-gray-100 border-gray-300 text-gray-700' },
            { id: 'yellow_chev_out', name: '黃槽化線外', category: 'F', type: 'linear', factors: [0.1], color: 'bg-yellow-100 border-yellow-300 text-yellow-900' },
            { id: 'yellow_chev_in', name: '黃槽化線內', category: 'F', type: 'linear', factors: [0.2], color: 'bg-yellow-100 border-yellow-300 text-yellow-900' },

            // --- G. 其他與未分類 ---
            { id: 'slow_wedge', name: '楔形減速標線', category: 'G', type: 'count', factors: [1.0, 0.3], color: 'bg-orange-50 border-orange-200 text-orange-800' },
            { id: 'rumble_strip', name: '跳動路面', category: 'G', type: 'linear', factors: [0.1, 3.0, 6.0], color: 'bg-orange-50 border-orange-200 text-orange-800' },
            { id: 'blind_path', name: '導盲線', category: 'G', type: 'linear', factors: [0.05, 2.0, 3.0], color: 'bg-orange-50 border-orange-200 text-orange-800' },
        ];

        let types = [];
        let selectedTypeId = '';
        let inputValue = '';
        let historyData = [];

        // ----------------------
        // 2. 核心邏輯函數
        // ----------------------

        // 載入並合併類型
        function loadTypes() {
            let stored = JSON.parse(localStorage.getItem('marking_types'));

            // 檢查舊資料是否包含 category，若無則重置
            // 由於這次改動很大，如果發現項目沒有 category 欄位，建議重置
            if (!stored || !Array.isArray(stored) || (stored.length > 0 && (!stored[0].factors || !stored[0].category))) {
                types = JSON.parse(JSON.stringify(INITIAL_TYPES));
            } else {
                const customItems = stored.filter(t => t.id.startsWith('custom_'));
                // 確保自訂項目有分類，若無則設為 G
                customItems.forEach(item => {
                    if (!item.category) item.category = 'G';
                });
                types = [...JSON.parse(JSON.stringify(INITIAL_TYPES)), ...customItems];
            }

            if (types.length > 0) {
                const exists = types.find(t => t.id === selectedTypeId);
                if (!exists) {
                    selectedTypeId = types[0].id;
                }
            }

            localStorage.setItem('marking_types', JSON.stringify(types));
        }

        function resetTypes() {
            if (confirm('確定要載入新的施工項目清單嗎？(您的自訂項目將會被移除)')) {
                types = JSON.parse(JSON.stringify(INITIAL_TYPES));
                localStorage.setItem('marking_types', JSON.stringify(types));
                selectedTypeId = types[0].id;
                renderTypes();
                updateScreen();
            }
        }

        // 輔助函式：移除無意義小數點零
        function fmtNum(num) {
            return parseFloat(num.toFixed(2));
        }

        // 統一取得單位名稱
        function getUnitName(type) {
            if (type.type === 'linear') return 'm';
            if (type.name.includes('行穿線')) return '條'; // 通用檢查行穿線
            if (type.name.includes('字') || type.id.includes('text') || type.id.includes('word')) return '字';
            if (type.name.includes('點') || type.id.includes('dot')) return '點';
            if (type.name.includes('條')) return '條';
            if (type.name.includes('支')) return '支';
            return '組';
        }

        // 計算一個項目的總係數乘積
        function getFactorProduct(factors) {
            return factors.reduce((acc, cur) => acc * cur, 1);
        }

        // 格式化顯示係數公式 (傳入 type 物件以便檢查名稱)
        function fmtFactors(factors, typeObj) {
            const name = typeObj.name || '';
            const id = typeObj.id || (typeof typeObj === 'string' ? typeObj : '');

            // 行穿線通用檢查 (包含自訂的行穿線)
            if ((name.includes('行穿線') || id === 'zebra_cross') && factors.length > 0) {
                const f0 = fmtNum(factors[0]);
                const rest = factors.slice(1).map(f => fmtNum(f));
                if (rest.length > 0) {
                    return `${f0}m*${rest.join('*')}`;
                }
                return `${f0}m`;
            }
            return factors.map(f => fmtNum(f)).join('*');
        }

        function getSelectedType() {
            return types.find(t => t.id === selectedTypeId) || types[0];
        }

        // 初始化渲染
        function init() {
            loadTypes();
            renderTypes();
            updateScreen();
            lucide.createIcons();

            // 監聽鍵盤按鍵
            document.addEventListener('keydown', (e) => {
                if (e.key >= '0' && e.key <= '9') inputKey(e.key);
                if (e.key === '.') inputKey('.');
                if (e.key === 'Backspace') inputKey('DEL');
                if (e.key === 'Enter') submitInput();
                if (e.key === 'Escape') inputKey('AC');
            });

            // 監聽 Modal
            document.getElementById('custom-name').addEventListener('input', updateCustomPreview);
            document.getElementById('custom-factors').addEventListener('input', updateCustomPreview);
            document.getElementById('custom-type').addEventListener('change', updateCustomPreview);
        }

        // 渲染類型按鈕 (分類版)
        function renderTypes() {
            const container = document.getElementById('type-list-container');
            container.innerHTML = '';

            // 取得所有分類的 Key
            const catKeys = Object.keys(CATEGORIES);

            catKeys.forEach(catKey => {
                // 篩選該分類的項目
                const catItems = types.filter(t => t.category === catKey);

                // 如果該分類有項目，則渲染
                if (catItems.length > 0) {
                    // 建立分類標題
                    const section = document.createElement('div');

                    const header = document.createElement('h3');
                    header.className = "text-xs font-bold text-slate-400 mb-2 pl-1 border-l-4 border-slate-300";
                    header.innerText = CATEGORIES[catKey];
                    section.appendChild(header);

                    // 建立網格
                    const grid = document.createElement('div');
                    // 保持原本的 Grid 設定
                    grid.className = "grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-1.5";

                    catItems.forEach(type => {
                        const btn = document.createElement('button');
                        const isSelected = type.id === selectedTypeId;
                        const unit = getUnitName(type);

                        // 產生公式字串
                        const factorProd = getFactorProduct(type.factors);
                        const formulaText = `1${unit}×${fmtFactors(type.factors, type)}=${fmtNum(factorProd)}m²`;

                        btn.className = `
                            relative p-1 rounded-lg border-2 text-left transition-all btn-active flex flex-col justify-between h-14 shadow-sm bg-white
                            ${isSelected
                                ? 'border-blue-500 ring-2 ring-blue-200 bg-white z-10'
                                : `${type.color} border-transparent hover:opacity-90`}
                        `;
                        btn.onclick = () => selectType(type.id);
                        btn.innerHTML = `
                            <div class="font-bold text-xs leading-tight break-words line-clamp-2">${type.name}</div>
                            <div class="text-[9px] opacity-70 mt-0.5 font-mono bg-white/50 inline-block px-1 rounded break-all leading-tight truncate w-full">
                                ${formulaText}
                            </div>
                            ${isSelected ? '<div class="absolute top-0.5 right-0.5 w-1.5 h-1.5 bg-blue-500 rounded-full animate-pulse"></div>' : ''}
                        `;
                        grid.appendChild(btn);
                    });

                    section.appendChild(grid);
                    container.appendChild(section);
                }
            });

            // 新增自訂按鈕 (放在最後面，或放在 G 類後面)
            // 這裡我們把「新增按鈕」單獨做一個區塊，方便點擊
            const addSection = document.createElement('div');
            addSection.className = "mt-4 pt-4 border-t border-slate-200";
            const addBtn = document.createElement('button');
            addBtn.className = "w-full p-2 rounded-lg border-2 border-dashed border-slate-300 text-slate-400 flex items-center justify-center gap-2 hover:bg-slate-50 hover:text-slate-600 transition-colors h-12";
            addBtn.onclick = openModal;
            addBtn.innerHTML = `
                <i data-lucide="plus" class="w-4 h-4"></i>
                <span class="text-xs font-bold">新增自訂項目 (將歸類於 G 區)</span>
            `;
            addSection.appendChild(addBtn);
            container.appendChild(addSection);

            // 重整 Icon
            lucide.createIcons();
        }

        function selectType(id) {
            selectedTypeId = id;
            inputValue = ''; // 切換類型時清空輸入
            renderTypes();
            updateScreen();
        }

        // 修改目前項目的係數
        function editCurrentFactors() {
            const type = getSelectedType();
            if (!type) return;

            const currentStr = type.factors.map(f => fmtNum(f)).join('*');
            const newStr = prompt(`修改 "${type.name}" 的計算參數 (例如: 長度*寬度):\n目前設定: ${currentStr}`, currentStr);

            if (newStr !== null && newStr !== currentStr) {
                const newFactors = parseFactors(newStr);
                if (newFactors.length > 0) {
                    type.factors = newFactors;
                    // 更新記憶體中的 types 陣列後，寫入 localStorage
                    localStorage.setItem('marking_types', JSON.stringify(types));

                    renderTypes();
                    updateScreen();
                } else {
                    alert('格式錯誤，請輸入數字或算式 (例如: 3.5*0.4)');
                }
            }
        }

        // 數字鍵盤邏輯
        function inputKey(key) {
            if (key === 'AC') {
                inputValue = '';
            } else if (key === 'DEL') {
                inputValue = inputValue.slice(0, -1);
            } else if (key === '.') {
                if (!inputValue.includes('.')) {
                    inputValue += key;
                }
            } else {
                if (inputValue.length < 8) {
                    inputValue += key;
                }
            }
            updateScreen();
        }

        function updateScreen() {
            const type = getSelectedType();
            const val = parseFloat(inputValue);

            // 更新類型名稱
            document.getElementById('screen-type-name').innerText = type.name;

            // 更新數值顯示
            const displayVal = inputValue || '0';
            document.getElementById('screen-value').innerText = displayVal;

            // 更新單位
            const unit = getUnitName(type);
            let unitLabel = `${unit} (數量)`;
            if (type.type === 'linear') unitLabel = 'm (長度)';
            document.getElementById('screen-unit').innerText = unitLabel;

            // 更新即時計算預覽
            const previewEl = document.getElementById('screen-calc-preview');
            if (val > 0) {
                const totalFactor = getFactorProduct(type.factors);
                const area = val * totalFactor;

                // 顯示完整乘法鏈
                const factorStr = fmtFactors(type.factors, type);
                const formula = `${fmtNum(val)}${unit} × ${factorStr} = ${fmtNum(area)} m²`;
                previewEl.innerText = formula;
            } else {
                previewEl.innerText = '';
            }
        }

        // 播放確認音效 (金幣聲)
        function playConfirmSound() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;

                const ctx = new AudioContext();
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                // 金幣音效：高頻快速爬升 (1200Hz -> 3000Hz)
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(1200, ctx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(3000, ctx.currentTime + 0.1);

                // 音量控制：清脆短促
                gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);

                oscillator.start();
                oscillator.stop(ctx.currentTime + 0.25);
            } catch (e) {
                console.error('AudioContext error:', e);
            }
        }

        // 提交輸入
        function submitInput() {
            const val = parseFloat(inputValue);
            const type = getSelectedType();

            if (!type || isNaN(val) || val <= 0) return;

            const totalFactor = getFactorProduct(type.factors);
            const area = val * totalFactor;

            const newItem = {
                id: Date.now(),
                typeId: type.id,
                name: type.name,
                inputType: type.type,
                factors: [...type.factors],
                inputValue: val,
                area: area
            };

            historyData = [newItem, ...historyData]; // 新的在最上面
            inputValue = '';

            playConfirmSound(); // 播放音效

            updateScreen();
            renderHistory();
        }

        // 渲染列表
        function renderHistory() {
            const list = document.getElementById('history-list');
            const totalEl = document.getElementById('display-total-area');

            list.innerHTML = '';
            let total = 0;

            if (historyData.length === 0) {
                list.innerHTML = '<div class="text-center text-slate-400 mt-10 text-sm">暫無資料<br>請輸入數值後按確認</div>';
            } else {
                historyData.forEach(item => {
                    total += item.area;
                    const el = document.createElement('div');
                    el.className = "bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center animate-fadeIn";

                    // 傳入 item 本身作為 typeObj 檢查名稱
                    const factorStr = fmtFactors(item.factors, item);
                    const unit = getUnitName({ type: item.inputType, id: item.typeId, name: item.name });

                    el.innerHTML = `
                        <div class="overflow-hidden">
                            <div class="font-bold text-slate-700 text-sm truncate">${item.name}</div>
                            <div class="text-xs text-slate-500 truncate">
                                ${fmtNum(item.inputValue)}${unit} 
                                <span class="text-slate-300">|</span> 
                                係: ${factorStr}
                            </div>
                        </div>
                        <div class="text-right flex items-center gap-2 shrink-0">
                            <div class="font-mono font-bold text-blue-600 text-sm">
                                ${fmtNum(item.area)} m²
                            </div>
                            <button onclick="deleteItem(${item.id})" class="text-slate-300 hover:text-red-500 p-1">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `;
                    list.appendChild(el);
                });
            }

            totalEl.innerText = fmtNum(total);
            lucide.createIcons();
        }

        function deleteItem(id) {
            historyData = historyData.filter(i => i.id !== id);
            renderHistory();
        }

        function clearAll() {
            if (confirm('確定要清空所有紀錄嗎？')) {
                historyData = [];
                renderHistory();
            }
        }

        // ----------------------
        // 3. 自訂項目功能
        // ----------------------
        function openModal() {
            document.getElementById('modal-custom').classList.remove('hidden');
            updateCustomLabels();
        }

        function closeModal() {
            document.getElementById('modal-custom').classList.add('hidden');
            document.getElementById('custom-name').value = '';
            document.getElementById('custom-factors').value = '';
        }

        function updateCustomLabels() {
            updateCustomPreview();
        }

        // 解析係數輸入字串 (例如 "1.0*0.5")
        function parseFactors(str) {
            if (!str) return [];
            // 分割 * 或 x 或 空格
            return str.split(/[\*\sx]+/).map(s => parseFloat(s)).filter(n => !isNaN(n) && n > 0);
        }

        function updateCustomPreview() {
            const type = document.getElementById('custom-type').value;
            const factorStr = document.getElementById('custom-factors').value;
            const factors = parseFactors(factorStr);
            const previewEl = document.getElementById('custom-preview');

            if (factors.length === 0) {
                previewEl.innerText = `1${type === 'linear' ? 'm' : '點'} * ? = ? m²`;
                return;
            }

            const totalFactor = getFactorProduct(factors);
            const displayFactors = fmtFactors(factors, { name: 'custom' }); // Preview generic

            // 預覽以輸入 1 為例
            previewEl.innerText = type === 'linear'
                ? `1m * ${displayFactors} = ${fmtNum(totalFactor)} m²`
                : `1點 * ${displayFactors} = ${fmtNum(totalFactor)} m²`;
        }

        function saveCustomType() {
            const name = document.getElementById('custom-name').value.trim();
            const typeMode = document.getElementById('custom-type').value;
            const factorStr = document.getElementById('custom-factors').value;
            const factors = parseFactors(factorStr);

            if (!name || factors.length === 0) {
                alert('請輸入正確的名稱與係數算式 (例如 0.1 或 1.0*0.5)');
                return;
            }

            const newType = {
                id: 'custom_' + Date.now(),
                name: name,
                category: 'G', // 預設歸類為 G
                type: typeMode,
                factors: factors,
                color: 'bg-purple-50 border-purple-200 text-purple-800'
            };

            types.push(newType);
            localStorage.setItem('marking_types', JSON.stringify(types));

            renderTypes();
            closeModal();
            selectType(newType.id);
        }

        // ----------------------
        // 4. 報表輸出邏輯 (多階係數支援)
        // ----------------------
        function copyReport() {
            if (historyData.length === 0) return;

            let text = `【道路標線施工統計】\n`;
            text += `時間:${new Date().toLocaleString()}\n`;
            text += `\n`;

            // 分組邏輯
            const groups = {};

            [...historyData].reverse().forEach(item => {
                if (!groups[item.name]) {
                    groups[item.name] = {
                        items: [],
                        type: item.inputType,
                        typeId: item.typeId, // Added for unit check
                        factors: item.factors,
                        totalArea: 0
                    };
                }
                groups[item.name].items.push(item.inputValue);
                groups[item.name].totalArea += item.area;
            });

            const groupAreas = [];

            Object.keys(groups).forEach(name => {
                const g = groups[name];
                const values = g.items;
                const sum = values.reduce((a, b) => a + b, 0);

                const sumFmt = fmtNum(sum);
                // 組合係數顯示 (例如 1*0.1)
                const factorStr = fmtFactors(g.factors, { name: name, id: g.typeId });
                const areaFmt = fmtNum(g.totalArea);

                const unit = getUnitName({ type: g.type, id: g.typeId, name: name });

                // 格式: 名稱:(3+5)=8m*1*0.1=0.8m²
                if (values.length > 1) {
                    const valJoined = values.map(v => fmtNum(v)).join('+');
                    text += `${name}:(${valJoined})=${sumFmt}${unit}*${factorStr}=${areaFmt}m²\n`;
                } else {
                    text += `${name}:${sumFmt}${unit}*${factorStr}=${areaFmt}m²\n`;
                }

                groupAreas.push(areaFmt);
            });

            // 總計
            const totalArea = historyData.reduce((sum, item) => sum + item.area, 0);
            text += `\n`;

            let totalFormula = "";
            if (groupAreas.length > 1) {
                totalFormula = `(${groupAreas.join('+')})=`;
            }

            text += `標線總計:${totalFormula}${fmtNum(totalArea)}m²`;

            // 執行複製
            const textarea = document.createElement("textarea");
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showToast();
            } catch (err) {
                alert('複製失敗');
            }
            document.body.removeChild(textarea);
        }

        function showToast() {
            const toast = document.getElementById('toast');
            toast.classList.remove('hidden');
            toast.classList.add('flex');
            setTimeout(() => {
                toast.classList.add('hidden');
                toast.classList.remove('flex');
            }, 2000);
        }

        // 啟動
        init();

        // ... existing styles ...
    </script>
</body>

</html>